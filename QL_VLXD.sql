CREATE DATABASE QL_VLXD
USE QL_VLXD

CREATE TABLE NHANVIEN
(
MANV CHAR(20) NOT NULL PRIMARY KEY,
HOTEN NVARCHAR(100) NOT NULL,
PHAI NVARCHAR(10) NOT NULL,
DIACHI NVARCHAR(100) NOT NULL,
SDT CHAR(50),
NGAYSINH DATE,
NGAYVAOLAM DATE,
LUONGCANBAN FLOAT,
SOGIOLAMCHUATINHTIEN FLOAT DEFAULT 0
) 

CREATE TABLE TAIKHOAN
(
MANV CHAR(20) NOT NULL primary key,
TENDANGNHAP CHAR(100),
MATKHAU CHAR(100),
CHUCVU NVARCHAR(50)
CONSTRAINT FK_TAIKHOAN_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
)

CREATE TABLE CHAMCONG
(
MANV CHAR(20) NOT NULL,
TIENTHUONG FLOAT DEFAULT 0,
SOGIOLAMDATINHTIEN FLOAT DEFAULT 0,
NGAYNHANLUONG DATE DEFAULT GETDATE(),  
TONGTIEN FLOAT DEFAULT 0,
CONSTRAINT FK_CHAMCONG_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
)

CREATE TABLE KHO
(
MAKHO CHAR(100) NOT NULL PRIMARY KEY,
TENKHO NVARCHAR(100) NOT NULL,
DIACHI NVARCHAR(100), 
SDT CHAR(50)
)

CREATE TABLE VATLIEU
(
MAVL CHAR(100) NOT NULL PRIMARY KEY ,
TENVL NVARCHAR(100)NOT NULL,
SOLUONG INT,
DONVITINH NVARCHAR(100)NOT NULL,
DONGIA FLOAT,
MAKHO CHAR(100) NOT NULL,
NGAYNHAPHANG DATE DEFAULT GETDATE()
CONSTRAINT FK_VATLIEU_MAKHO FOREIGN KEY(MAKHO) REFERENCES KHO(MAKHO)
) 


CREATE TABLE PHIEUHANG
(
MANV CHAR(20) NOT NULL,
MAPHIEU CHAR(100) NOT NULL,
MAVL CHAR(100)NOT NULL,
PRIMARY KEY(MAPHIEU),
NGAYTAO DATE DEFAULT GETDATE(),
THANHTIEN REAL DEFAULT 0,
CHECK (THANHTIEN>=0),
CONSTRAINT FK_PHIEUHANG_MAVL FOREIGN KEY(MAVL) REFERENCES VATLIEU(MAVL),
CONSTRAINT FK_PHIEUHANG_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
)

CREATE TABLE CT_PHIEUHANG
(
MAPHIEU CHAR(100) NOT NULL,
MAVL CHAR(100) NOT NULL,
PRIMARY KEY(MAPHIEU),
SOLUONG INT,
CHECK (SOLUONG>0),
DONGIA REAL,
CHECK (DONGIA>0),
CONSTRAINT FK_CT_PHIEUHANG_MAPHIEU FOREIGN KEY(MAPHIEU) REFERENCES PHIEUHANG(MAPHIEU),
HOTEN_KH NVARCHAR(100) NOT NULL,
SDT CHAR(15) DEFAULT 0
)



SET DATEFORMAT DMY
INSERT INTO NHANVIEN
VALUES 
('ADMIN',N'ĐẶNG VĂN DUY',N'Nam',N'Bình Định','0969705512','20/10/2000','22/11/2019','',''),
('NV02',N'Nguyễn Văn Ngọc',N'Nam',N'Quảng Nam','9862591247','08/06/1999','20/10/2020','30000',''),
('NV03',N'Lê Văn Giàu',N'Nam',N'Hồ Chí Minh','0939247575','28/06/2001','15/02/2020','50000','')

--NHẬP DỮ LIỆU CHO BẢNG TAIKHOAN
INSERT INTO TAIKHOAN
VALUES
('ADMIN','nguyenvana','1',N'Chủ'),
('NV02','nguyenvanb','2',N'Nhân viên'),
('NV03','nguyenvanc','3',N'Nhân viên')

set dateformat DMY
INSERT INTO CHAMCONG
VALUES
('NV02','25000','',getdate(),''),
('NV03','23000','','22/12/2020','0')
--NHẬP DỮ LIỆU CHO BẢNG KHO
INSERT INTO KHO
VALUES
('K1',N'KHO VẬT LIỆU XÂY DỰNG HỒNG LOAN',N'HÓC MÔN, TP.HCM','123'),
('K2',N'KHO GẠCH THANH TÙNG',N'BÌNH TÂN, TP.HCM','345'),
('K3',N'KHO GẠCH MEN MINH CHIẾN',N'LONGAN','456'),
('K4',N'KHO NẸP ĐỒNG, NẸP NHÔM, NẸP INOX',N'VŨNG TÀU','567')

--NHẬP DỮ LIỆU CHO VATLIEU
SET DATEFORMAT DMY
INSERT INTO VATLIEU
VALUES 
('VL01',N'GẠCH MEN','100',N'HỘP','100000','K3','20/04/2020'),
('VL02',N'GIÀN GIÁO','200',N'CÁI','70000','K1','08/06/2020'),
('VL03',N'XI MĂNG','500',N'BAO','20000','K1','28/06/2020'),
('VL04',N'NGÓI','10',N'THIÊN','500000','K2','30/06/2020'),
('VL05',N'CÁT','50',N'XE','200000','K1','05/12/2020')

--NHẬP DỮ LIỆU CHO PHIEUHANG
SET DATEFORMAT DMY
INSERT INTO PHIEUHANG
VALUES
('NV02','P01','VL01','15/02/2018','100.000'),
('NV03','P02','VL02','17/05/2019','20.000'),
('NV02','P03','VL01','29/07/2019','500.000')

--NHẬP DỮ LIỆU CHO CT_PHIEUHANG
INSERT INTO CT_PHIEUHANG
VALUES
('P02','VL03','4','100000',N'NGÔ VĂN MƯỜI','0123'),
('P03','VL01','9','500000',N'NGUYỄN VĂN ĐÔ','9870'),
('P01','VL04','5','1000000',N'PHẠM NGUYỄN DUY TRÂN','4567')


-----------tạo thủ hiển thị nhân viên 
create PROC HIENTHINV
@CHUCVU CHAR(100)
AS
BEGIN
select distinct(nhanvien.MANV) AS N'Mã Nhân Viên', HOTEN AS' Họ và Tên', PHAI as'Giới Tính', DIACHI as 'Địa Chỉ',SDT AS N'Số điện thoại', NGAYSINH as'Ngày Sinh', ngayvaolam as N'Ngày vào làm', LUONGCANBAN AS N'Lương căn bản', SOGIOLAMCHUATINHTIEN AS N'Số giờ làm'
from NHANVIEN, TAIKHOAN
where NHANVIEN.MANV=TAIKHOAN.MANV
and taikhoan.CHUCVU=@CHUCVU
END


-----------------
create PROC HIENTHIVATLIEU1
@SANPHAM CHAR(100)
AS
BEGIN
select VATLIEU.MAVL AS N'Mã Vật liệu', TENVL AS' Tên vật liệu', SOLUONG as'SỐ LƯỢNG', DONVITINH as 'ĐƠN VỊ TÍNH',DONGIA AS N'ĐƠN GIÁ',KHO.MAKHO AS'Mã kho', NGAYNHAPHANG as N'Ngày nhập hàng'
from VATLIEU,KHO
where VATLIEU.MAKHO=KHO.MAKHO
END
-------------------------------------------
create proc timVl
@tenvl nvarchar(100)
as
begin
select VATLIEU.MAVL as N'Mã vật liệu', TENVL as N'Tên vật liệu', SOLUONG as N'Số lượng', DONVITINH as N'Đơn vị tính', DONGIA as N'Đơn giá', TENKHO as N'Tên kho', NGAYNHAPHANG as N' Ngày nhập hàng' from vatlieu, kho where VATLIEU.MAKHO= kho.MAKHO and TENVL=@tenvl
end

exec timVl @tenvl=N'đá'

-------------------------------------------
CREATE PROC HIENTHIPHIEUHANG
 @PHIEUHANG CHAR(100)
AS
BEGIN
select PHIEUHANG.MAPHIEU AS N'Mã PHIẾU HÀNG', NHANVIEN.HOTEN AS' Tên NHÂN VIÊN', VATLIEU.MAVL as'MÃ VẬT LIỆU', NGAYTAO as 'NGÀY TẠO',THANHTIEN AS N'THÀNH TIỀN'
from PHIEUHANG,NHANVIEN,VATLIEU
where PHIEUHANG.MANV=NHANVIEN.MANV AND VATLIEU.MAVL=PHIEUHANG.MAVL
END

----------------------------------------------
CREATE PROC HIENTHICTPHIEUHANG
 @CTPHIEUHANG CHAR(100)
AS
BEGIN
select CT_PHIEUHANG.MAPHIEU AS N'Mã PHIẾU HÀNG', VATLIEU.MAVL as'MÃ VẬT LIỆU',CT_PHIEUHANG.SOLUONG AS'SỐ LƯỢNG' ,CT_PHIEUHANG.DONGIA as 'NGÀY TẠO',HOTEN_KH AS N'THÀNH TIỀN'
from CT_PHIEUHANG,VATLIEU,PHIEUHANG
where VATLIEU.MAVL=CT_PHIEUHANG.MAVL AND PHIEUHANG.MAPHIEU=CT_PHIEUHANG.MAPHIEU
END

--TÌM NHÂN VIÊN DỰA VÀO TÊN CỦA NHÂN VIÊN NHẬP TRÊN txtTimkiem
create PROC TIMNV
@TENNV NVARCHAR(50)
AS
BEGIN
	SELECT TAIKHOAN.MANV AS N'Mã Nhân Viên', HOTEN AS' Họ và Tên', PHAI as'Giới Tính', DIACHI as 'Địa Chỉ',SDT AS N'Số điện thoại', NGAYSINH as'Ngày Sinh', ngayvaolam as N'Ngày vào làm', LUONGCANBAN AS N'Lương căn bản', SOGIOLAMCHUATINHTIEN AS N'Số giờ làm'
	from NHANVIEN, TAIKHOAN
	where NHANVIEN.MANV=TAIKHOAN.MANV
	and CHUCVU=N'NHÂN VIÊN'
	AND HOTEN=@TENNV
END


--Tim mat hang vat lieu 
create PROC TIMVLXD
@TENVL NVARCHAR(50)
AS
BEGIN
	SELECT VATLIEU.MAVL AS N'Mã vật liệu', TENVL AS'tên vật liệu', SOLUONG as'số lượng', DONVITINH as 'đơn vị tính',DONGIA AS N'đơn giá', KHO.MAKHO as'mã kho'
	from VATLIEU,KHO
	where VATLIEU.MAKHO=KHO.MAKHO
	AND TENVL=@TENVL
END

---------------Tìm phiếu hàng
create PROC TIMPH
@MAPHIEU NVARCHAR(50)
AS
BEGIN
	SELECT PHIEUHANG.MAPHIEU AS N'Mã phiếu', VATLIEU.MAVL AS'mã vật liệu', NHANVIEN.MANV as'mã nhân viên', NGAYTAO as 'Ngày tạo',THANHTIEN AS N'thành tiền'
	from PHIEUHANG,NHANVIEN,VATLIEU
	where PHIEUHANG.MANV=NHANVIEN.MANV and PHIEUHANG.MAVL=VATLIEU.MAVL
	AND MAPHIEU=@MAPHIEU
END

---------------------------
---------------Tìm kiếm chi tiết phiếu mua hàng của khách
create PROC TIMCTPH
@HOTEN_KH NVARCHAR(50)
AS
BEGIN
	SELECT PHIEUHANG.MAPHIEU AS N'Mã phiếu', VATLIEU.MAVL AS'mã vật liệu', CT_PHIEUHANG.SOLUONG as'số lượng', CT_PHIEUHANG.DONGIA as 'đơn giá',HOTEN_KH AS N'họ tên khách hàng'
	from CT_PHIEUHANG,PHIEUHANG,VATLIEU
	where CT_PHIEUHANG.MAPHIEU=PHIEUHANG.MAPHIEU AND CT_PHIEUHANG.MAVL=VATLIEU.MAVL
	AND HOTEN_KH=@HOTEN_KH
END

----------------------
create PROC KTMAPHIEU
@MAPHIEU NVARCHAR(50)
AS
BEGIN
	SELECT PHIEUHANG.MAPHIEU AS N'Mã phiếu'
	from PHIEUHANG
	where MAPHIEU=@MAPHIEU
END

----tạo thủ tục nhận lương của nhân viên
CREATE PROC LICHSUNHANLUONG
@TENNV NVARCHAR(100)
AS
BEGIN
select nhanvien.MANV AS N'Mã Nhân Viên', HOTEN as N'Họ tên',LUONGCANBAN as N'Lương căn bản', SOGIOLAMDATINHTIEN as N'Số giờ làm', TIENTHUONG as N'Tiền Thưởng',tongtien as N'Tổng tiền', NGAYNHANLUONG as N'Ngày nhận lương' 
from chamcong, nhanvien
where chamcong.MANV=NHANVIEN.MANV
and HOTEN=@TENNV
and sogiolamdatinhtien>0
END


-----TẠO THỦ TỤC HIỂN THỊ DOANH THU
CREATE PROC HIENTHIDOANHTHU
@NGAYBATDAu DATE, @NGAYKETTHUc DATE
AS
BEGIN
select HOTEN AS N'Họ tên nhân viên',MAPHIEU as 'Mã Phiếu',TENVL as N'Tên vật liệu', NGAYTAO as N'Ngày tạo', THANHTIEN as 'Tiền'  from NHANVIEN,PHIEUHANG,VATLIEU where NHANVIEN.MANV=PHIEUHANG.MANV and PHIEUHANG.MAVL=VATLIEU.MAVL and NGAYTAO>=@NGAYBATDAU and NGAYTAO<=@NGAYKETTHUc
END



--Tìm Vật liệu

create PROC TIMVATLIEU
@NGAYNHAPBATDAU DATE, @NGAYNHAPKETTHUC DATE
AS
BEGIN
select v.MAVL as N'Mã vật liệu', TENVL as N'Tên vật liệu', SOLUONG as N'Số lượng', DONVITINH as N'Đơn vị tính', DONGIA as N'Đơn giá', TENKHO as N'Tên kho',DIACHI as N'Địa chỉ', NGAYNHAPHANG as N'Ngày nhập hàng', k.MAKHO as N'Mã kho' from vatlieu v, kho k where v.MAKHO=k.MAKHO and SOLUONG>0 and NGAYNHAPHANG>=@NGAYNHAPBATDAU and NGAYNHAPHANG<=@NGAYNHAPKETTHUC
END



CREATE PROC LOGGIN
@TENDANGNHAP NVARCHAR(100),@MATKHAU CHAR(50)
AS
BEGIN
select count(*) from taikhoan where TENDANGNHAP=@TENDANGNHAP and MATKHAU=@MATKHAU
END
